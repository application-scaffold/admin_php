= admin_php
:toc:

== åå°ç›®å½•

- `admin_api`ï¼šåå°ä¸º åå°ç®¡ç†å•åº”ç”¨è®¿é—®çš„ `api` æ¥å£æ¨¡å—ã€‚
- `front_api`ï¼šåå°ä¸º å‰ç«¯åº”ç”¨è®¿é—®çš„ `api` æ¥å£æ¨¡å—ã€‚
- `common`ï¼šä¸ºåå°å…¬å…±æ¨¡å—ã€‚

=== ç›®å½•

[source, text]
----
â”œâ”€ğŸ“‚ admin_php  //æœåŠ¡ç«¯æ ¹ç›®å½•ï¼ˆç®¡ç†åå°ã€æ¥å£ï¼‰
â”‚  â”œâ”€ğŸ“‚ app  //åº”ç”¨ç›®å½•
â”‚  â”‚  â”œâ”€ğŸ“‚ admin_api  //ç®¡ç†åå°æ¥å£
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚config //é…ç½®
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚controller //æ§åˆ¶å™¨
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚http
â”‚  â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚middleware //ä¸­é—´ä»¶
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚listener //äº‹ä»¶ç›‘å¬
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚lists //åˆ—è¡¨ç±»
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚logic //é€»è¾‘ç±»
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚service //æœåŠ¡ç±»
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚validate //éªŒè¯ç±»
â”‚  â”‚  â”œâ”€ğŸ“‚ common  //å…¬å…±æ¨¡å—
â”‚  â”‚  â”œâ”€ğŸ“‚ front_api  //å‰ç«¯åå°æ¥å£
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚config //é…ç½®
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚controller //æ§åˆ¶å™¨
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚http
â”‚  â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚middleware //ä¸­é—´ä»¶
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚listener //äº‹ä»¶ç›‘å¬
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚lists //åˆ—è¡¨ç±»
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚logic //é€»è¾‘ç±»
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚service //æœåŠ¡ç±»
â”‚  â”‚  â”‚  â”œâ”€ğŸ“‚validate //éªŒè¯ç±»
â”‚  â”œâ”€ğŸ“‚ public  //WEBç›®å½•ï¼ˆå¯¹å¤–è®¿é—®ç›®å½•ï¼‰
â”‚  â”‚  â”œâ”€ğŸ“„ index.php  //phpå…¥å£æ–‡ä»¶
â”‚  â”‚  â”œâ”€ğŸ“‚ admin  //å·²ç¼–è¯‘çš„vue adminåå°å‰ç«¯ä»£ç å…¥å£
â”‚  â”‚  â”œâ”€ğŸ“‚ mobile  //å·²ç¼–è¯‘çš„uniapp mobileå‰ç«¯ä»£ç å…¥å£
â”‚  â”‚  â”œâ”€ğŸ“‚ pc  //å·²ç¼–è¯‘çš„nuxt pcå‰ç«¯ä»£ç å…¥å£
â”‚  â”‚  â”œâ”€ğŸ“‚ install  //å®‰è£…ç¨‹åºç›®å½•
â”‚  â”‚  â”œâ”€ğŸ“‚ swagger-ui  //æ¥å£æ–‡æ¡£ç›®å½•
â”‚  â”œâ”€ğŸ“„ .env  //é¡¹ç›®ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆæœ€ä¼˜åŒ–è¯»å–é…ç½®ï¼‰
----

== å‘½åè§„èŒƒ

`admin_php` éµå¾ª `PSR-2` å‘½åè§„èŒƒå’Œ `PSR-4` è‡ªåŠ¨åŠ è½½è§„èŒƒã€‚

== æŠ€æœ¯

ä½¿ç”¨ç›®å‰æœ€æµè¡Œçš„æŠ€æœ¯ï¼š

- PHP8
- ThinkPHP8
- mysql
- swagger3

== æ–‡æ¡£

https://doc.thinkphp.cn[å®Œå…¨å¼€å‘æ‰‹å†Œ]

== éƒ¨ç½²å®‰è£…

=== ç¯å¢ƒè¦æ±‚

[cols="4,3,3"]
|===
|è¿è¡Œç¯å¢ƒ|è¦æ±‚ç‰ˆæœ¬|æ¨èç‰ˆæœ¬

|PHP
|>=8.0
|8.0

|Mysql
|>=5.7
|5.7

|nginx æˆ– apache
|æ— é™åˆ¶
|-
|===

=== éƒ¨ç½²

é¡¹ç›®å…¥å£æ–‡ä»¶ï¼šserver/public/index.php

==== nginxé…ç½®

[source, conf]
----
server {
    listen 80;
    server_name  demo.myadmin.cn;
    access_log /logs/demo.myadmin.cnt_access_nginx.log;
    error_log /logs/demo.myadmin.cn_error_nginx.log;
    client_max_body_size 5M;
    location / {
        root  admin_php/public;#å…¥å£æ–‡ä»¶ç›®å½•
        index  index.html index.htm index.php;
        if (!-e $request_filename)
        {
            rewrite ^/(.*)$ /index.php?s=$1 last;
            break;
        }
    }
    location ~ /.*\.php/ {
        rewrite ^(.*?/?)(.*\.php)(.*)$ /$2?s=$3 last;
        break;
    }
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /var/www/html;
    }

    location ~ \.php$ {
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  admin_php/public$fastcgi_script_name; #å…¥å£æ–‡ä»¶ç›®å½•
        include        fastcgi_params;
    }
    location = /favicon.ico {
            log_not_found off;
            access_log off;
        }
}
----

nginx ä¼ªé™æ€ï¼š

[source, conf]
----
if (!-e $request_filename)
{
    rewrite ^/(.*)$ /index.php?s=$1 last;
    break;
}
----

==== apacheé…ç½®

[source, conf]
----
<IfModule mod_rewrite.c>
  Options +FollowSymlinks -Multiviews
  RewriteEngine On

RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.*)$ index.php/$1 [QSA,PT,L]
</IfModule>
----

==== è®¿é—®åœ°å€

éƒ¨ç½²å®‰è£…ä»¥åç®¡ç†åå°å…¥å£åœ°å€ï¼š http://åŸŸå/admin_api

== ä»£ç ç”Ÿæˆå™¨

* TODO

== ç”Ÿæˆæ–‡æ¡£

=== è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£

å‰ç«¯ apiï¼š

* è®¿é—® [åŸŸå]/doc/generate/front

åç«¯ apiï¼š

* è®¿é—® [åŸŸå]/doc/generate/admin

=== æ‰‹åŠ¨ç”Ÿæˆæ–‡æ¡£

å‰ç«¯ apiï¼š

[source, bash]
----
php vendor/zircote/swagger-php/bin/openapi app/front_api/controller -o public/swagger-ui/front.json --format json
----

åç«¯ apiï¼š

[source, bash]
----
php vendor/zircote/swagger-php/bin/openapi app/admin_api/controller -o public/swagger-ui/admin.json --format json
----

== å„ç«¯åå°

=== è¯·æ±‚æµç¨‹

    æ¥å£è¯·æ±‚-->è¿›å…¥æ¨¡å— --> ä¸­é—´ä»¶ --> æ§åˆ¶å™¨ --> éªŒè¯ç±» --> [é€»è¾‘å±‚\åˆ—è¡¨ç±»\æœåŠ¡å±‚] --> è¿”å›ç»“æœ

åº”ç”¨ä½¿ç”¨å‰åç«¯åˆ†ç¦»ï¼ŒæœåŠ¡ç«¯åªæä¾›æ•°æ®æ¥å£ï¼Œé»˜è®¤è®¿é—®æ–¹å¼ä¸º "http://åŸŸå/æ¨¡å—åç§°/æ§åˆ¶å™¨åç§°/æ§åˆ¶å™¨æ–¹æ³•"ã€‚

ä»£ç æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. å…ˆæ ¹æ®æ¥å£ url æ‰¾åˆ°æ¨¡å—ï¼Œè¿›å…¥æ¨¡å—ä¸­é—´ä»¶ï¼Œä¸­é—´ä»¶é¡ºåºåœ¨ [admin_api/front_api]/config/route.php ä¸­é…ç½®ã€‚
2. ç„¶åè¿›å…¥æ§åˆ¶å™¨ï¼Œä¸€èˆ¬æ§åˆ¶å™¨ç±»å‹ä¸ºæŸ¥çœ‹æ•°æ®çš„æ“ä½œï¼Œä¸ä¼šæœ‰éªŒè¯ç±»ï¼Œæ•°æ®æäº¤ç±»å‹æœ‰éªŒè¯ç±»ã€‚
3. æ¥ç€æŒ‰éœ€æ±‚æ‰§è¡Œé€»è¾‘å±‚æˆ–åˆ—è¡¨ç±»æˆ–æœåŠ¡å±‚ï¼Œç„¶åè¿”å›ç»“æœã€‚

=== æ¨¡å—

æ ¹æ® thinkphp å¼€å‘è§„èŒƒï¼Œä¸€èˆ¬æ¨¡å—æ”¾åœ¨ server/app ç›®å½•ä¸‹ï¼Œæ ¹æ®ä¸šåŠ¡å®šä¹‰æ¨¡å—ã€‚

- admin_api ç›®å‰é’ˆå¯¹ç®¡ç†åå°å®šä¹‰ server/app/admin_api æ¨¡å—
- front_api ç›®å‰é’ˆå¯¹å‰ç«¯åå°å®šä¹‰ server/app/front_api æ¨¡å—
- åç»­ä¼šå°ç¨‹åºæ¨¡å—ç­‰ã€‚

=== ä¸­é—´ä»¶

ä¸­é—´ä»¶é…ç½®åœ¨ [admin_api/front_api]/config/route.php æ–‡ä»¶ï¼ŒæŒ‰é¡ºåºè¿è¡Œåˆå§‹åŒ–ä¸­é—´ä»¶ï¼Œç™»å½•éªŒè¯ä¸­é—´ä»¶ï¼Œæƒé™è®¤è¯ä¸­é—´ä»¶ã€‚

==== åˆå§‹åŒ–

åˆå§‹åŒ–ä¸­é—´ä»¶è·¯å¾„ä¸º http/middleware/InitMiddleware.phpï¼Œç”¨äºæ¨¡å—åˆå§‹åŒ–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€æ±‚ä¿®æ”¹ã€‚

==== ç™»å½•éªŒè¯

ç™»å½•éªŒè¯ä¸­é—´ä»¶è·¯å¾„ä¸º [admin_api/front_api]/http/middleware/LoginMiddleware.phpï¼Œç”¨äºéªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œç™»å½•çš„ç”¨æˆ·ä¼šåœ¨è¯·æ±‚çš„ header é‡Œé¢æ”¾æœ‰æ•ˆçš„ token å‚æ•°ï¼Œé€šè¿‡ token å‚æ•°å¯ä»¥çŸ¥é“ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥åœ¨æ§åˆ¶å™¨ç­‰å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚

æœ‰è¿™äº›æ¥å£æ˜¯ä¸éœ€è¦éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼ˆæ¯”å¦‚ç™»å½•æ¥å£ï¼‰ï¼Œå¯ä»¥åœ¨æ§åˆ¶å™¨ä¸­è®¾ç½®ï¼Œå‚è€ƒæ§åˆ¶å™¨ç›¸å½“å…³æ–‡æ¡£ã€‚

[source, php]
----
<?php
namespace app\adminapi\controller;
class LoginController extends BaseAdminController
{
    public array $notNeedLogin = ['account', 'logout'];
    public function account(){}
    public function logout(){}
}
----

==== æƒé™è®¤è¯

æƒé™è®¤è¯çš„ä¸­é—´ä»¶è·¯å¾„ä¸º [admin_api]/http/middleware/AuthMiddleware.phpï¼Œç”¨æˆ·éªŒè¯ç™»å½•è´¦å·çš„è§’è‰²æ˜¯å¦æ‹¥æœ‰è¯¥æ¥å£çš„è®¿é—®æƒé™ã€‚

=== æ§åˆ¶å™¨

==== è®¿é—®

æ§åˆ¶å™¨ç›®å½•åœ¨ [æ¨¡å—/controller]ï¼Œå¯ä»¥ç›´æ¥åœ¨ `controller` ç›®å½•æ–°å¢æ§åˆ¶å™¨ç±»ï¼Œè®¿é—®ä¸º "http://åŸŸå/æ¨¡å—/æ§åˆ¶å™¨ç±»åç§°/æ§åˆ¶å™¨æ–¹æ³•"ï¼Œä¹Ÿå¯ä»¥åœ¨ `controller` å†æ–°å»ºæ§åˆ¶å™¨ç›®å½•ï¼Œå†æ–°å»ºæ§åˆ¶å™¨ï¼Œè®¿é—®ä¸º "http://åŸŸå/æ¨¡å—/æ§åˆ¶å™¨ç›®å½•.æ§åˆ¶å™¨åç§°/æ§åˆ¶å™¨æ–¹æ³•"ã€‚

==== ç»§æ‰¿

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ§åˆ¶å™¨éœ€è¦ç»§æ‰¿æ¨¡å—çš„åŸºç¡€æ§åˆ¶å™¨ã€‚

ç®¡ç†åå°æ¨¡å—çš„æ§åˆ¶å™¨ç»§æ‰¿ `BaseAdminController` æ§åˆ¶å™¨ï¼Œç”¨æˆ·ç™»å½•çŠ¶æ€ä¸‹ï¼Œå¯ä»¥é€šè¿‡ `+$this->adminId+` è·å–ç®¡ç†å‘˜ idï¼Œ`+$this->adminInfo+` è·å–ç®¡ç†å‘˜ä¿¡æ¯ã€‚

[source, php]
----
<?php
namespace app\adminapi\controller;

use app\adminapi\controller\BaseAdminController;

class TestController extends BaseAdminController
{
    //ç™»å½•æ¥å£
    public function index()
    {
        $this->adminId; //ç®¡ç†å‘˜id
        $this->adminInfo; //ç®¡ç†å‘˜å±æ€§
    }
}
----

==== ç™»å½•

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ§åˆ¶å™¨æ–¹æ³•éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ã€‚ä¹Ÿå¯ä»¥è®¾ç½®æ§åˆ¶å™¨çš„ `$notNeedLogin` å±æ€§ï¼Œå¢åŠ å¤šä¸ªä¸éœ€è¦ç™»å½•éªŒè¯çš„æ§åˆ¶å™¨æ–¹æ³•åç§°ã€‚

[source, php]
----
<?php
namespace app\adminapi\controller;

use app\adminapi\controller\BaseAdminController;

class LoginController extends BaseAdminController
{
    public array $notNeedLogin = ['account', 'logout'];

    //ç™»å½•æ¥å£
    public function account()
    {
        //â€¦â€¦
    }

    //é€€å‡ºç™»å½•æ¥å£
    public function logout()
    {
        //â€¦â€¦
    }
}
----

==== å“åº”

ä¸ºäº†è§„èŒƒæ¥å£è¿”å›å€¼ï¼Œæ¥å£çš„æ•°æ®æ ¼å¼ä¸å‰ç«¯çº¦å®šï¼Œæ ¼å¼å’Œè¯´æ˜å¦‚ä¸‹ã€‚

[source, json]
----
{
    "code": 1,
    "show": 0,
    "msg": "",
    "data": {
        "lists": [],
        "count": 0,
        "page_no": 1,
        "page_size": 15,
        "extend": []
    }
}
----

[cols="2,2,1,1,4"]
|===
|å­—æ®µ|åç§°|ç±»å‹|å¿…éœ€|è¯´æ˜

|code
|çŠ¶æ€ç 
|int
|æ˜¯
|1-ä¸šåŠ¡æ­£å¸¸;0-ä¸šåŠ¡éªŒè¯ä¸é€šè¿‡

|show
|æç¤ºçŠ¶æ€
|int
|æ˜¯
|1-æ˜¾ç¤ºæç¤ºè¯­å†…å®¹ï¼›0-ä¸æ˜¾ç¤ºæç¤ºå†…å®¹

|msg
|æç¤ºè¯­
|string
|æ˜¯
|è½»å¼¹çª—å‡ºæç¤º

|data
|æ•°æ®
|object
|æ˜¯
|ä¸šåŠ¡æ•°æ®

|-list
|åˆ—è¡¨æ•°ç»„
|array
|å¦
|æ•°æ®åˆ—è¡¨æ•°ç»„å†…å®¹

|-count
|è®°å½•æ•°
|int
|å¦
|æ•°æ®åˆ—è¡¨æ€»è®°å½•æ•°

|-page_no
|é¡µé¢åºå·
|int
|å¦
|å½“å‰é¡µåºå·

|-page_size
|æ¯é¡µè®°å½•æ•°
|int
|å¦
|å½“å‰æ¯é¡µè®°å½•æ•°

|-extend
|é¢å¤–å‚æ•°
|array
|å¦
|é¢å¤–å‚æ•°ï¼Œæ ¹æ®éœ€è¦ä½¿ç”¨
|===

æ¥å£è¿”å›ä¸€èˆ¬ä¼šä½¿ç”¨æ§åˆ¶å™¨çš„å‡ ä¸ªæ–¹æ³•ï¼š

- successï¼šæ–¹æ³•è¡¨ç¤ºä¸šåŠ¡æ­£å¸¸ï¼Œä¹Ÿå¯ä»¥ç”¨äºè¿”å›æ¥å£æ•°æ®ã€‚
- dataï¼šæ–¹æ³•ç”¨äºè¿”å›æ•°æ®ã€‚
- dataListsï¼šæ–¹æ³•ä¸“é—¨ç”¨äºè¿”å›åˆ—è¡¨æ•°æ®ï¼ŒåŒ…å«åˆ—è¡¨å¯¼å‡ºã€‚

[cols="2,3,5"]
|===
|æ–¹æ³•åç§°|è°ƒç”¨è¯´æ˜|å‚æ•°

|success()
|è¿”å›ä¸šåŠ¡æ­£å¸¸æˆ–æ•°æ®
|$msg:æç¤ºè¯­;$data:æ•°æ®;$code:çŠ¶æ€ç ;$show:æç¤ºè¯­

|fail()
|è¿”å›æ•°æ®
|$data:æ•°æ®

|data()
|è¿”å›æ•°æ®
|$lists: åˆ—è¡¨ç±»

|lists()
|è¿”å›åˆ—è¡¨æ•°æ®
|$msg:æç¤ºè¯­;éªŒè¯ç  æ‹¦æˆªåä¼šè‡ªåŠ¨å¤„ç†ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦ä½¿ç”¨
|===

[source, php]
----
<?php
namespace app\adminapi\controller;

use app\adminapi\controller\BaseAdminController;

class TestController extends BaseAdminController
{
    //ç™»å½•æ¥å£
    public function index()
    {
        return $this->success();//æˆåŠŸ
        return $this->fail(); //å¤±è´¥
        return $this->data(); //è¿”å›æ•°æ®
        return $this->dataLists(); //è¿”å›æ•°æ®åˆ—è¡¨
    }
}
----

=== éªŒè¯ç±»

åœ¨è·å–è¯·æ±‚å‚æ•°ååšç®€å•çš„å‚æ•°æ ¡éªŒ

å®ç°æ­¥éª¤ï¼š

1. ä¸šåŠ¡éªŒè¯ç±»ç»§æ‰¿ `BaseValidate` éªŒè¯åŸºç±»
2. ä¸šåŠ¡æ§åˆ¶å™¨å®ä¾‹åŒ–ä¸šåŠ¡éªŒè¯ç±»ï¼Œè°ƒç”¨ `goCheck($scene, $validateData)` æ–¹æ³•ã€‚

ç¤ºä¾‹ï¼š

[source, php]
----
<?php
namespace app\adminapi\validate\auth;

use app\common\validate\BaseValidate;

// éªŒè¯å™¨
class AdminValidate extends BaseValidate
{

    protected $rule = [
        'name' => 'require',
    ];

    protected $message = [
        'name.require' => 'åç§°ä¸èƒ½ä¸ºç©º',
    ];

    // æ·»åŠ åœºæ™¯
    public function sceneAdd()
    {
        return $this->only(['name']);
    }

}

<?php
namespace app\adminapi\controller\auth;

use app\adminapi\controller\BaseAdminController;
use app\adminapi\validate\auth\AdminValidate;

// æ§åˆ¶å™¨
class AdminController extends BaseAdminController
{
    public function add()
    {
        // gocheck($scene, $validateData)
        // $scene => åœºæ™¯ $validateData => éªŒè¯å‚æ•°(å¯è¿½åŠ æˆ–è¦†ç›–æ¥æ”¶åˆ°çš„è¯·æ±‚å‚æ•°)
        // post
        $params = (new AdminValidate())->post()->goCheck('add');
        // get
        // $params = (new AdminValidate())->goCheck('detail');
        //â€¦â€¦
    }
}
----

=== åˆ—è¡¨ç±»

å®ç°æ­¥éª¤ï¼š

1. æ–°å»ºåˆ—è¡¨ç±»ç»§æ‰¿åˆ—è¡¨åŸºç±» `BaseAdminDataLists`
2. æ§åˆ¶å™¨ä¸­ç»§æ‰¿æ§åˆ¶å™¨åŸºç±» `BaseAdminController`ï¼Œè°ƒç”¨ `dataLists()`

å…¶ä»–ï¼š

1. åˆ†é¡µä½¿ç”¨ `limit()` æ–¹æ³•
2. æä¾›äº†å‡ ä¸ªæ¥å£åŠ å¼ºåˆ—è¡¨ç±»çš„åº”ç”¨

- ListsSearchInterface - æœç´¢
- ListsExtendInterface - æ‰©å±•å‚æ•°
- ListsSortInterface - æ’åº
- ListsExcelInterface - å¯¼å‡º `Excel`

ç¤ºä¾‹ï¼š

[source, php]
----
<?php

namespace app\adminapi\lists\auth;

use app\adminapi\lists\BaseAdminDataLists;
use app\common\lists\ListsSearchInterface;

// åˆ—è¡¨ç±»
class AdminLists extends BaseAdminDataLists implements ListsSearchInterface
{
    // æœç´¢æ¡ä»¶
    public function setSearch(): array
    {
        return [
            '%like%' => ['name', 'account'],
        ];
    }

    // æŸ¥è¯¢åˆ—è¡¨æ•°æ®
    public function lists(): array
    {
        return Admin::where($this->searchWhere)
            ->limit($this->limitOffset, $this->limitLength)
            ->select()
            ->toArray();
    }

    // è·å–æ•°é‡
    public function count(): int
    {
        return Admin::where($this->searchWhere)->count();
    }
}

<?php
namespace app\adminapi\controller;

use app\adminapi\controller\BaseAdminController;
use app\adminapi\lists\DemoLists;

// æ§åˆ¶å™¨
class AdminController extends BaseAdminController
{
    public function lists()
    {
        return $this->dataLists(new AdminLists());
    }
}
----

==== åˆ—è¡¨å¯¼å‡º

å®ç°æ­¥éª¤ï¼š

1. ä¸šåŠ¡åˆ—è¡¨ç±»å®ç° `ListsExcelInterface` æ¥å£.è¯¥æ¥å£å¿…é¡»å®ç° `setExcelFields()` å’Œ `setFileName()` æ–¹æ³•

- setExcelFields() ç”¨äºè®¾ç½®å¯¼å‡ºå­—æ®µ
- setFileName() ç”¨äºè®¾ç½®é»˜è®¤å¯¼å‡ºæ–‡ä»¶å

2. å‰ç«¯è¯·æ±‚åˆ—è¡¨æ¥å£æ—¶å¸¦ä¸Šå¯¼å‡ºæ‰€éœ€å‚æ•°

å…¶ä»–ï¼š

1. å¯¼å‡ºç›®å½•ä¸º server/runtime/file/export/
2. å¯¼å‡ºå…·ä½“é€»è¾‘å‚è€ƒ app/common/lists/ListsExcelTrait.php

å‰ç«¯æ¥å£è¯·æ±‚å‚æ•°ï¼š

[cols="2,1,1,6"]
|===
|å‚æ•°å|å¿…é€‰|ç±»å‹|è¯´æ˜

|export
|æ˜¯
|int
|å¯¼å‡º excel

|file_name
|å¦
|string
|å¯¼å‡ºæ–‡ä»¶å; è‹¥ä¸ä¼ é€’ï¼Œä½¿ç”¨åç«¯è®¾ç½®çš„é»˜è®¤æ–‡ä»¶å

|page_type
|å¦
|int
|å¯¼å‡ºæ•°æ®ç±»å‹ 0-å¯¼å‡ºå…¨éƒ¨æ•°æ® 1(é»˜è®¤)-å¯¼å‡ºæŒ‡å®šåˆ†é¡µçš„æ•°æ®(ä¾‹ï¼šå¯¼å‡ºç¬¬2é¡µè‡³ç¬¬5é¡µæ•°æ®æ—¶ï¼ŒåŒæ—¶è¦ä¼ é€’page_start = 2,page_end=5)

|page_size
|å¦
|int
|å½“ page_type=1 æ—¶æœ‰æ•ˆï¼Œä»£è¡¨æ¯é¡µçš„æ•°é‡ï¼Œ é»˜è®¤å€¼25

|page_start
|å¦
|int
|å½“ page_type=1 æ—¶æœ‰æ•ˆï¼Œä»£è¡¨å¯¼å‡ºçš„èµ·å§‹é¡µç ï¼Œ é»˜è®¤å€¼1

|page_end
|å¦
|int
|å½“ page_type=1 æ—¶æœ‰æ•ˆï¼Œä»£è¡¨å¯¼å‡ºçš„ç»“æŸé¡µç ï¼Œ é»˜è®¤å€¼200
|===

ç¤ºä¾‹ï¼š

[source, php]
----
<?php
namespace app\adminapi\lists;

use app\adminapi\lists\BaseAdminDataLists;
use app\common\lists\ListsExcelInterface;

// åˆ—è¡¨ç±»
class DemoLists extends BaseAdminDataLists implements ListsExcelInterface
{
    // æŸ¥è¯¢åˆ—è¡¨æ•°æ®
    public function lists(): array
    {
        //â€¦â€¦
    }

    // æŸ¥è¯¢æ•°é‡
    public function count(): int
    {
        //â€¦â€¦
    }

    // è®¾ç½®å¯¼å‡ºå­—æ®µ
    public function setExcelFields(): array
    {
        return [
            'nickname' => 'æ˜µç§°',
            'mobile' => 'æ‰‹æœºå·',
        ];
    }

    // è®¾ç½®å¯¼å‡ºæ–‡ä»¶é»˜è®¤åç§°
    public function setFileName(): string
    {
        return 'ç”¨æˆ·è®°å½•';
    }
}

<?php
namespace app\adminapi\controller;

use app\adminapi\controller\BaseAdminController;
use app\adminapi\lists\DemoLists;

// å‰ç«¯è¯·æ±‚åˆ—è¡¨æ¥å£ /adminapi/demo/lists?export=2&page_type=1&page_start=1&page_end=2.å³å¯è·å¾—excelä¸‹è½½åœ°å€ã€‚
class DemoController extends BaseAdminController
{
    public function lists()
    {
        return $this->dataLists(new DemoLists());
    }
}
----

=== å®šæ—¶ä»»åŠ¡

åœ¨ç³»ç»Ÿä¸­æ·»åŠ å¥½ä¸šåŠ¡æ‰€éœ€å®šæ—¶ä»»åŠ¡ï¼Œè¿è¡Œ `crontab` å®šæ—¶ä»»åŠ¡æ¥å¤„ç†å„å­ä»»åŠ¡ã€‚ ä»¥ä¸‹ç¤ºä¾‹ä¸­ `www/wwwroot/admin_php/think` ä¸ºé¡¹ç›®çš„ `think` æ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œæ ¹æ®è‡ªå·±é¡¹ç›®å®é™…è·¯å¾„å¤„ç†ã€‚

å„ç¯å¢ƒé…ç½®å®šæ—¶ä»»åŠ¡ï¼š

1. å®å¡”ã€‚åœ¨è®¡åˆ’ä»»åŠ¡é¡µé¢ä¸­æ·»åŠ  `crontab` å®šæ—¶ä»»åŠ¡ã€‚è®¾ç½®è„šæœ¬å†…å®¹: php /www/wwwroot/admin_php/think crontabã€‚

2. LINUXã€‚æ‰§è¡Œ `crontab -e`ï¼Œè®¾ç½®è„šæœ¬å†…å®¹ï¼š */1 * * * * php /www/wwwroot/admin_php/think crontabã€‚

3. dockerã€‚è¿›è¡Œ `php` å®¹å™¨ï¼Œè®¾ç½®è„šæœ¬å†…å®¹ï¼š */1 * * * * docker exec php-7.2.4-fpm php /admin_php/think crontabã€‚

